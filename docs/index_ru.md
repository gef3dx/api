# Документация FastAPI Backend

## Содержание

- [Обзор проекта](#обзор-проекта)
- [API endpoints](#api-endpoints)
  - [Аутентификация](#аутентификация)
  - [Пользователи](#пользователи)
  - [Профили](#профили)
  - [Уведомления](#уведомления)
  - [Сообщения](#сообщения)
- [Руководство по разработке](#руководство-по-разработке)
  - [Установка](#установка)
  - [Структура проекта](#структура-проекта)
  - [Тестирование](#тестирование)
  - [Качество кода](#качество-кода)
- [Деплой](#деплой)
  - [Docker](#docker)
  - [CI/CD](#cicd)

## Обзор проекта

Это бэкенд-сервис на FastAPI с архитектурой repository/service. Система реализует аутентификацию, управление профилем, систему уведомлений, систему личных сообщений и ролевую модель доступа (RBAC) с использованием современных инструментов Python и лучших практик.

Система уведомлений позволяет пользователям получать и управлять уведомлениями с разными типами (info, success, warning, error) и статусами (прочитано, не прочитано). Пользователи могут отправлять уведомления другим, получать свои уведомления, отмечать их как прочитанные и удалять.

Система сообщений позволяет отправлять личные сообщения другим пользователям, управлять входящими и исходящими сообщениями и выполнять CRUD-операции над ними.

## API endpoints

### Аутентификация

#### Регистрация нового пользователя
```
POST /api/v1/auth/register
```
Регистрирует нового пользователя и создает пустой профиль.

#### Логин
```
POST /api/v1/auth/login
```
Аутентифицирует пользователя и возвращает JWT токены.

#### Обновление токена
```
POST /api/v1/auth/refresh
```
Обновляет access-токен через refresh-токен.

#### Выход из системы
```
POST /api/v1/auth/logout
```
Отзывает текущий refresh-токен.

#### Выход со всех устройств
```
POST /api/v1/auth/logout-all
```
Отзывает все refresh-токены пользователя.

#### Запрос сброса пароля
```
POST /api/v1/auth/request-password-reset
```
Отправляет email для сброса пароля.

#### Подтверждение сброса пароля
```
POST /api/v1/auth/confirm-password-reset
```
Подтверждает сброс пароля по токену.

### Пользователи

#### Текущий пользователь
```
GET /api/v1/users/me
```
Возвращает текущего пользователя (без профиля). Требуется авторизация.

#### Конкретный пользователь
```
GET /api/v1/users/{id}
```
Возвращает пользователя. Требуется роль администратора.

#### Обновление пользователя
```
PATCH /api/v1/users/{id}
```
Обновляет данные пользователя. Требуется роль администратора.

#### Список пользователей
```
GET /api/v1/users
```
Возвращает список пользователей. Требуется роль администратора.

### Профили

#### Профиль текущего пользователя
```
GET /api/v1/profiles/me
```
Возвращает профиль текущего пользователя. Требуется авторизация.

#### Обновление профиля текущего пользователя
```
PATCH /api/v1/profiles/me
```
Обновляет профиль текущего пользователя. Требуется авторизация.

#### Профиль конкретного пользователя
```
GET /api/v1/profiles/{user_id}
```
Возвращает профиль пользователя. Требуется роль администратора.

#### Обновление профиля конкретного пользователя
```
PATCH /api/v1/profiles/{user_id}
```
Обновляет профиль пользователя. Требуется роль администратора.

### Уведомления

#### Отправка уведомления
```
POST /api/v1/notifications/
```
Отправляет уведомление пользователю. Требуется авторизация.

Тело запроса:
```json
{
  "title": "string",
  "message": "string",
  "type": "info|success|warning|error",
  "user_id": "uuid"
}
```

#### Получение уведомлений пользователя
```
GET /api/v1/notifications/
```
Возвращает уведомления текущего пользователя. Поддерживает фильтрацию по статусу. Требуется авторизация.

Параметры запроса:
- `status`: фильтр по статусу (unread|read)
- `limit`: количество уведомлений (по умолчанию 100)
- `offset`: смещение для пагинации (по умолчанию 0)

Ответ:
```json
{
  "notifications": [
    {
      "id": "uuid",
      "user_id": "uuid",
      "title": "string",
      "message": "string",
      "type": "info|success|warning|error",
      "status": "unread|read",
      "is_read": "boolean",
      "read_at": "datetime|null",
      "created_at": "datetime",
      "updated_at": "datetime"
    }
  ],
  "total": "integer"
}
```

#### Количество непрочитанных уведомлений
```
GET /api/v1/notifications/unread-count
```
Возвращает количество непрочитанных уведомлений. Требуется авторизация.

Ответ:
```json
{
  "count": "integer"
}
```

#### Получение конкретного уведомления
```
GET /api/v1/notifications/{notification_id}
```
Возвращает уведомление. Требуется авторизация и владение уведомлением.

Ответ:
```json
{
  "id": "uuid",
  "user_id": "uuid",
  "title": "string",
  "message": "string",
  "type": "info|success|warning|error",
  "status": "unread|read",
  "is_read": "boolean",
  "read_at": "datetime|null",
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

#### Обновление уведомления
```
PATCH /api/v1/notifications/{notification_id}
```
Обновляет уведомление. Требуется авторизация и владение уведомлением.

Тело запроса:
```json
{
  "title": "string|null",
  "message": "string|null",
  "type": "info|success|warning|error|null",
  "status": "unread|read|null",
  "is_read": "boolean|null"
}
```

#### Отметить уведомления как прочитанные
```
POST /api/v1/notifications/mark-as-read
```
Отмечает несколько уведомлений как прочитанные. Требуется авторизация и владение уведомлениями.

Тело запроса:
```json
{
  "notification_ids": ["uuid"]
}
```

#### Удаление уведомления
```
DELETE /api/v1/notifications/{notification_id}
```
Удаляет уведомление. Требуется авторизация и владение уведомлением.

### Сообщения

#### Отправка сообщения
```
POST /api/v1/messages/
```
Отправляет сообщение пользователю. Требуется авторизация.

Тело запроса:
```json
{
  "recipient_id": "uuid",
  "subject": "string",
  "content": "string"
}
```

#### Входящие сообщения
```
GET /api/v1/messages/inbox
```
Возвращает сообщения, полученные текущим пользователем. Требуется авторизация.

Параметры запроса:
- `skip`: количество пропущенных сообщений (по умолчанию 0)
- `limit`: максимальное количество сообщений (по умолчанию 100)

Ответ:
```json
{
  "messages": [
    {
      "id": "uuid",
      "sender_id": "uuid",
      "recipient_id": "uuid",
      "subject": "string",
      "content": "string",
      "created_at": "datetime",
      "updated_at": "datetime"
    }
  ],
  "total": "integer"
}
```

#### Исходящие сообщения
```
GET /api/v1/messages/sent
```
Возвращает сообщения, отправленные текущим пользователем. Требуется авторизация.

Параметры запроса:
- `skip`: количество пропущенных сообщений (по умолчанию 0)
- `limit`: максимальное количество сообщений (по умолчанию 100)

Ответ:
```json
{
  "messages": [
    {
      "id": "uuid",
      "sender_id": "uuid",
      "recipient_id": "uuid",
      "subject": "string",
      "content": "string",
      "created_at": "datetime",
      "updated_at": "datetime"
    }
  ],
  "total": "integer"
}
```

#### Конкретное сообщение
```
GET /api/v1/messages/{message_id}
```
Возвращает сообщение. Требуется авторизация и владение (отправитель или получатель).

Ответ:
```json
{
  "id": "uuid",
  "sender_id": "uuid",
  "recipient_id": "uuid",
  "subject": "string",
  "content": "string",
  "created_at": "datetime",
  "updated_at": "datetime"
}
```

#### Обновление сообщения
```
PATCH /api/v1/messages/{message_id}
```
Обновляет сообщение. Требуется авторизация и владение (только отправитель).

Тело запроса:
```json
{
  "subject": "string|null",
  "content": "string|null"
}
```

#### Удаление сообщения
```
DELETE /api/v1/messages/{message_id}
```
Удаляет сообщение. Требуется авторизация и владение (отправитель или получатель).

## Руководство по разработке

### Установка

1. Создайте виртуальное окружение:
   ```bash
   python -m venv venv
   source venv/bin/activate  # Windows: venv\Scripts\activate
   ```

2. Установите зависимости:
   ```bash
   make install-dev
   ```

3. Скопируйте и настройте переменные окружения:
   ```bash
   cp .env.example .env
   # Отредактируйте .env
   ```

4. Выполните миграции:
   ```bash
   alembic upgrade head
   ```

5. Запустите сервер:
   ```bash
   make dev
   ```

### Структура проекта

Проект следует подходу domain-driven design:

```
app/
  core/                 # Основные утилиты и конфигурация
  db/                   # Конфигурация базы данных
  di/                   # Внедрение зависимостей
  api/                  # API роутеры и зависимости
  domain/               # Доменные модули (users, profiles, auth, notifications)
    users/              # Управление пользователями
    profiles/           # Управление профилями
    auth/               # Аутентификация
    notifications/      # Система уведомлений
    messages/           # Система сообщений
  utils/                # Утилиты
```

### Тестирование

Запуск тестов:
```bash
make test
```

С покрытием:
```bash
make test-cov
```

### Качество кода

Инструменты для поддержки качества кода:

- **Black** – автоформатирование
- **Ruff** – быстрый линтер
- **MyPy** – статическая типизация

Запуск всех проверок:
```bash
make check-quality
```

Форматирование:
```bash
make format
```

## Деплой

### Docker

Запуск в Docker:
```bash
docker-compose up --build
```

### CI/CD

Проект включает GitHub Actions:

- **CI Pipeline** – запускается при каждом push и pull request
- **Deployment Pipeline** – запускается при публикации релиза

